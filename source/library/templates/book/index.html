{% extends 'layouts/default/page.html' %}

{% load i18n %}
{% block content %}

{% if request.user.is_authenticated %}

      Username Anda Adalah <b>{{ request.user.username }}</b>.
      <div class="container mt-4">
          <h2>Daftar Buku</h2>

          <!-- Filter -->
          <div class="mb-3">
              <button class="btn btn-outline-primary" id="filterAll">Semua Buku</button>
              <button class="btn btn-outline-success" id="filterFavorite">Favorit Saya</button>
          </div>

          <table id="booksTable" class="table table-striped table-bordered">
              <thead>
                  <tr>
                      <th>Thumbnail</th>
                      <th>Judul</th>
                      <th>Deskripsi</th>
                      <th>Genre</th>
                      <th>Action</th>
                  </tr>
              </thead>
          </table>
      </div>

    {% else %}

      

        <div class="d-flex flex-column align-items-center justify-content-center text-center" style="min-height: 200px;">
            <h4 class="mb-4">Kamu belum login</h4>
            <a class="btn btn-primary mb-4" href="{% url 'accounts:log_in' %}">Log in</a>
           
        </div>

{% endif %}



{% endblock %}

{% block script %}
<!-- DataTables & jQuery -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">


<script>
$(document).ready(function() {
    let table = $('#booksTable').DataTable({
        "ajax": "{% url 'book_masterdata_ajax' %}",
        "columns": [
            { 
                "data": "image_url",
                "render": function(data, type, row) {
                    return '<img src="' + data + '" alt="cover" style="width:80px;">';
                },
                "orderable": false,
                "searchable": false
            },
            { "data": "judul" },
            { "data": "deskripsi" },
            { "data": "genre" },
            { "data": "action", "orderable": false, "searchable": false }
        ],
        "pageLength": 5,
        "lengthChange": false,
        "pagingType": "full_numbers"
    });

    // Filter tombol
    $('#filterAll').on('click', function() {
        table.ajax.url("{% url 'book_masterdata_ajax' %}").load();
    });

    $('#filterFavorite').on('click', function() {
        table.ajax.url("{% url 'book_masterdata_ajax' %}?favorited=1").load();
    });

    // Delegasi event click untuk tombol favorit (karena datanya AJAX)
    $('#booksTable').on('click', '.btn-favorite', function() {
        const bookId = $(this).data('book-id');
        const btn = $(this);

        fetch(`/library/book/favorite/${bookId}/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Accept': 'application/json'
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if (data.favorited) {
                    btn.removeClass('btn-outline-primary').addClass('btn-primary');
                } else {
                    btn.removeClass('btn-primary').addClass('btn-outline-primary');
                }
            } else {
                alert('Gagal update favorit');
            }
        })
        .catch(err => console.error(err));
    });
});

// Helper CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}