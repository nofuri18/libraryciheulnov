{% extends 'layouts/default/page.html' %}

{% load i18n %}
{% block content %}
<div class="content-wrapper">
    <!-- Header -->
    <div class="content-header mb-3">
        <h1>UPLOAD BUKU</h1>
    </div>
    <section class="container-fluid">
        <div class="row">
            <div class="col-md-12">

                <div class="box box-danger border-dark">

                    <form id="draftForm">
                        {% csrf_token %}
                        <div class="form-group row">
                            <div class="col-sm-6">
                                <label>Judul</label>
                                <input type="text" class="form-control" name="judul">
                            </div>
                            <div class="col-sm-6">
                                <label>Deskripsi</label>
                                  <textarea class="form-control" name="deskripsi" id="deskripsi" rows="4"></textarea>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-6">
                                <label>Tahun Terbit</label>
                                <input type="number" class="form-control" name="tahun_terbit" min="0" step="1" required>
                            </div>
                            <div class="col-sm-6">
                                <label>Penulis</label>
                                <input type="text" class="form-control" name="penulis">
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-6">
                                <label>Jumlah Halaman</label>
                                <input type="number" class="form-control" name="jumlah_halaman"  min="0" step="1" required>
                            </div>
                            <div class="col-sm-6">
                                <label for="genre">Genre Buku</label> 
                                <select id="genre" name="genre" class="form-control" required> 
                                    <option value="" disabled>-- Pilih Genre --</option>
                                    <option value="fiksi">Fiksi</option>
                                    <option value="komik">Komik</option>
                                    <option value="motivasi">Motivasi</option>
                                    <option value="lainnya">Lainnya</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="form-group row">
                                <div class="col-sm-6">
                                    <label>File PDF</label>
                                    <input type="file" class="form-control" name="file_pdf" id="file_pdf" accept="application/pdf" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 text-right mt-3">
                            <a class="btn btn-warning" href="{% url 'book_masterdata' %}">Back</a>
                            <button type="button" class="btn btn-primary" onclick="submitBook()">Upload</button>
                        </div>
                    </form>

                    <div class="box-footer"></div>
                    <!-- Loading overlay -->
                    <div id="loadingOverlay" 
                         style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
                                background:rgba(255,255,255,0.7); z-index:9999; 
                                justify-content:center; align-items:center; font-size:20px; font-weight:bold;">
                        <div class="spinner-border text-primary" role="status">
                          <span class="sr-only">Loading...</span>
                        </div>
                        <span class="ml-2">Sedang menyimpan data...</span>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block script %}

<script>
    const fileInput = document.getElementById("file_pdf");
    fileInput.addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        if (file.type !== "application/pdf") {
            alert("File harus berupa PDF!");
            this.value = ""; // reset input supaya tidak bisa submit
        }
    });

    function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex";
    }

    function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
    }

    function submitBook() {
        const form = document.getElementById("draftForm");
        const formData = new FormData(form);
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        showLoading(); // tampilkan loading

        fetch("{% url 'store_book_masterdata' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(); // sembunyikan loading
            if (data.data) {
                alert("Data berhasil disimpan!");
                window.location.href = "{% url 'book_masterdata' %}";
            } else {
                alert("Gagal menyimpan: " + data.message);
            }
        })
        .catch(err => {
            hideLoading();
            console.error("Fetch error:", err);
            alert("Terjadi error saat menyimpan data.");
        });
    }
</script>
{% endblock %}